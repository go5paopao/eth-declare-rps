<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>Ethereum じゃんけんゲーム</title>
    <meta http-equiv="content-type" charset="utf-8">   
    <link rel="stylesheet" type="text/css" href="style/main.css">
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js" charset="UTF-8"></script>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="/app/jsSHA/src/sha256.js" charset="UTF-8"></script>
    <script type="text/javascript" src="https://cdn.ethers.io/scripts/ethers-v3.min.js" charset="utf-8">
</script>
    <script>
      const web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
      const coinbase = web3.eth.coinbase;
      var abi;
      var address;
      var contract;
      var eventHostSubmit;
      var eventGuestSubmit;
      var eventGameResult;
      var eventMoneyMove;
      var eventMoneyBack;
      var ownerAddress = web3.eth.accounts[0];
      var hostAddress = web3.eth.accounts[0];
      var guestAddress = web3.eth.accounts[1];
      setAddressTable()
      $.getJSON("/build/contracts/rps.json", function(json){
        var _abi = json["abi"];
        var _address = json["networks"]["10"]["address"];
        setContract(_abi, _address);
      });
      var hostLocalHash = "";
      var hostEthHash = "";
      var guestLocalHash = "";
      var guestEthHash = "";
      var resultPattern = {
        0:"This game is not over yet.",
        1:"Host player Win!!!",
        2:"Guest Player Win!!!",
        3:"Draw!!!"
      }
      function setAddressTable(){
        window.onload = function () {
          document.getElementById("hostPlayerAddress").innerText = hostAddress;
          document.getElementById("guestPlayerAddress").innerHTML = guestAddress;
        };      
     }

      function setContract(_abi, _address){
        abi = _abi;
        address = _address;
        contract = web3.eth.contract(abi).at(address);
        setEvent();
      }

      function setEvent() {
        eventHostSubmit = contract.HostSubmit();
        eventGuestSubmit = contract.GuestSubmit();
        eventGameResult = contract.GameResult();
        eventMoneyMove = contract.MoneyMove();
        eventMoneyBack = contract.MoneyBack();
        eventHostSubmit.watch(function (error, result){
          console.log('host submit event');
          if (!error)
            console.log(result);
        });
        eventGuestSubmit.watch(function (error, result){
          console.log('guest submit event');
          if (!error)
            console.log(result);
        });
        eventGameResult.watch(function (error, result){
          console.log('game result event');
          if (!error)
            console.log(result);
        });
        eventMoneyMove.watch(function (error, result){
          console.log('money move event');
          if (!error)
            console.log(result);
        });
        eventMoneyBack.watch(function (error, result){
          console.log('money back event');
          if (!error)
            console.log(result);
        });     
      }
      
      function makeGame() {
        var rndStr = document.getElementById("hostRndStr").value;
        var hand;
        var radios = document.getElementsByName("hostHand");
        for(var i=0; i<radios.length;i++){
          if (radios[i].checked) {
            hand = radios[i].value;
            break;
          }
        }
        var handByte = numberToBytes32(hand);
        var rndByte = stringToBytes32(rndStr);
        var concatStr = bytesConcat(handByte,rndByte);
        hostLocalHash = contract.getHashValue.call(concatStr);
        console.log("hostLocalHash:"+hostLocalHash);
        contract.makeGame.sendTransaction(hostLocalHash,{from:hostAddress, gas:1000000});
        document.getElementById("hostLocalHash").innerHTML = hostLocalHash;
      }

      function joinGame() {
        var rndStr = document.getElementById("guestRndStr").value;
        var hand;
        var radios = document.getElementsByName("guestHand");
        for(var i=0; i<radios.length;i++){
          if (radios[i].checked) {
            hand = radios[i].value;
            break;
          }
        }
        var handByte = numberToBytes32(hand);
        var rndByte = stringToBytes32(rndStr);
        var concatStr = bytesConcat(handByte,rndByte);
        guestLocalHash = contract.getHashValue.call(concatStr);
        contract.joinGame.sendTransaction(guestLocalHash,hand,rndStr,{from:guestAddress,gas:1000000});
        document.getElementById("guestLocalHash").innerHTML = guestLocalHash;
      }

      function hostSubmit(){
        var rndStr = document.getElementById("hostRndStr").value;
        var hand;
        var radios = document.getElementsByName("hostHand");
        for(var i=0; i<radios.length;i++){
          if (radios[i].checked) {
            hand = radios[i].value;
            break;
          }
        }
        var res = contract.hostSubmitHand.sendTransaction(hand,rndStr,{from:hostAddress,gas:1000000});
        console.log(res);
      }

      function getHostEthHash() {
        var res = contract.getHostEthHash.call();
        console.log("response:"+res);
        document.getElementById("hostEthHash").innerHTML = res;
        return res
      }

      function getGuestEthHash() {
        var res = contract.getGuestEthHash.call();
        console.log("response:"+res);
        document.getElementById("guestEthHash").innerHTML = res;
        return res;
      }

      function hostGameCheck() {
        hostEthHash = getHostEthHash();
        if (hostEthHash == hostLocalHash){
          console.log("host hash is matched!!");
          document.getElementById("hostCheckResult").innerHTML = "Hash Check Success!!!"
        }
        else{
          console.log("host hash is not corrected.");
          document.getElementById("hostCheckResult").innerHTML = "Hash not mach. Host lose..."
        }
      }

      function guestGameCheck() {
        guestEthHash = getGuestEthHash();
        if (guestEthHash == guestLocalHash){
          console.log("guest hash is matched!!");
          document.getElementById("guestCheckResult").innerHTML = "Hash Check Success!!!"
        }
        else{
          console.log("guest hash is not corrected.");
          document.getElementById("guestCheckResult").innerHTML = "Hash not mach. Guest lose..."
        }
      }

      function showResult() {
        var result = contract.getGameResult.call();
        document.getElementById("showGameResult").innerHTML = resultPattern[result];
      }

      function showGamePhase() {
        var result = contract.getGamePhase.call();
        document.getElementById("showGamePhase").innerHTML = result;
      }

      // reset contract status for retry game 
      function reset(){
        contract.resetGame.sendTransaction({from:ownerAddress,gas:1000000});
      }

      function stringToBytes32(_text) {
        console.log("text:" + _text);
        console.log("text length:"+ _text.length);
        var result = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(_text));
        console.log("result:"+result);
        console.log("result length:"+result.length);
        while (result.length < 66) { result += '0'; }
        if (result.length !== 66) { throw new Error("invalid web3 implicit bytes32"); }
        return result;
      }

      function numberToBytes32(_number) {
        var result = _number;
        while (result.length < 64) { result = '0'+result; }
        if (result.length !== 64) { throw new Error("invalid web3 implicit bytes32"); }
        result = "0x" + result;
        return result;
      }

      function bytesConcat(bytesA, bytesB){
        console.log("bytesA:"+bytesA);
        console.log("bytesB:"+bytesB);
        return "0x" + bytesA.substring(2) + bytesB.substring(2);
      }

    </script>
  </head>

  <body>
    <header>
      <h1>Ethereum じゃんけん</h1>
    </header>
    <div class="content">
      <h2>What is it?</h2>
      <p>これはEthereumのブロックチェーン上で実現したじゃんけんゲームです。</p>
      <p>ブロックチェーンの特質を考慮したじゃんけんのため、通常のじゃんけんより手順が複雑です。</p>
      <!-- access Ethereum blockchain by host and guest player-->
      <h2>Action</h2>
      <h3>Host Player</h3>
      <h4>1.MakeGame</h4>
      <div class="chooseHandArea">
        <fieldset>
          <legend class="chooseHand">手を選んでください。</legend>
          <input type="radio" name="hostHand" id="hostHandRock" value="1" checked="checked">
          <label for="hostHandRock">グー</label>
          <input type="radio" name="hostHand" id="hostHandScissor" value="2">
          <label for="hostHandScissor">チョキ</label>
          <input type="radio" name="hostHand" id="hostHandPaper" value="3">
          <label for="hostHandPaper">パー</label>
        </fieldset>
      </div>
      <div class="inputRndStrArea">
        <fieldset>
          <legend class="inputRndStr">ランダムな文字列を入力してください。</legend>
          <input type="text" size=20 id="hostRndStr">
        </fieldset>
      </div> 
      <p>
        <input class="ethCallButton" type="button" value="START" onClick="makeGame()"/>
      </p>
      <h4>3.SubmitHand</h4>
      <p>
      <input type="button" class="ethCallButton" value="Submit&Battle" onClick="hostSubmit()"/>
      </p>
      <h4>(option) CheckHash</h4>
      <p>
      <input type="button" class="ethCallButton" value="Check" onClick="hostGameCheck()"/>
      </p>
       
      <h3>Guest Player</h3>
      <h4>2.JoinGame</h4>
      <div class="chooseHandArea">
        <fieldset>
          <legend class="chooseHand">手を選んでください。</legend>
          <input type="radio" name="guestHand" id="guestHandRock" value="1" checked="checked">
          <label for="guestHandRock">グー</label>
          <input type="radio" name="guestHand" id="guestHandScissor" value="2">
          <label for="guestHandScissor">チョキ</label>
          <input type="radio" name="guestHand" id="guestHandPaper" value="3">
          <label for="guestHandPaper">パー</label>
        </fieldset>
      </div>
      <div class="inputRndStrArea">
        <fieldset>
          <legend class="inputRndStr">ランダムな文字列を入力してください。</legend>
          <input type="text" size=20 id="guestRndStr">
        </fieldset>
      </div> 
      <p>
        <input class="ethCallButton" type="button" value="START" onclick="joinGame()"/>
      </p>
      <h4>(option) CheckHash</h4>
      <p>
      <input type="button" class="ethCallButton" value="Check" onClick="guestGameCheck()"/>
      </p>
      <h3>Result</h3>
      <p>      
      <input type="button" class="ethCallButton" value="ShowResult" onClick="showResult()"/>
      </p>
      <p>      
      <input type="button" class="ethCallButton"  value="RESET" onClick="reset()"/>
      </p>

      <!-- Show Status about this game and blockchain -->
      <h2>Status</h2>
      <h3>Battle Result</h3>
      <div id="showGameResult"></div>
      <h3>Player Address</h3>
      <table>
        <tbody>
          <tr>
            <th>HostPlayer</th>
            <td id="hostPlayerAddress"> </td>
          </tr>
          <tr>
            <th>GuestPlayer</th>
            <td id="guestPlayerAddress"> </td>
          </tr>
        </tbody>
      </table>
      <h3>Submit Hash</h3>
      <table>
        <tbody>
          <tr>
            <th>Host Local</th>
            <td id="hostLocalHash"></td>
          </tr>
          <tr>
            <th>Host Eth</th>
            <td id="hostEthHash"></td>
          </tr>
          <tr>
            <th>Guest Local</th>
            <td id="guestLocalHash"></td>
          </tr>
          <tr>
            <th>Guest Eth</th>
            <td id="guestEthHash"></td>
          </tr>
        </tbody>
      </table>
      <div id="hostCheckResult" class="hashCheckMessage"></div>
      <div id="guestCheckResult" class="hashCheckMessage"></div>
      <h2>Procedure</h2>
    </div>
    <!-- footer -->
    <footer>
      <p>COPYRIGHT &#169; go5paopao ALL RIGHTS RESERVED. </p>
    </footer>
  </body>

</html>
