<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>Ethereum RPS game</title>
    <script src="https://cdn.rawgit.com/ethereum/web3.js/0.19.0/dist/web3.min.js" charset="UTF-8"></script>
    <script src="../jsSHA/src/sha256.js" charset="UTF-8"></script>
    <script>
      const web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
      const coinbase = web3.eth.coinbase;
      //var abi = JSON.parse('[{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"hand","type":"uint8"},{"indexed":false,"name":"rndStr","type":"string"},{"indexed":false,"name":"hash","type":"bytes32"}],"name":"HostSubmit","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"hand","type":"uint8"},{"indexed":false,"name":"rndStr","type":"string"},{"indexed":false,"name":"hash","type":"bytes32"}],"name":"GuestSubmit","type":"event"},{"constant":false,"inputs":[{"name":"hashValue","type":"bytes32"}],"name":"makeGame","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"hashValue","type":"bytes32"},{"name":"hand","type":"uint8"},{"name":"rndStr","type":"string"}],"name":"joinGame","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"hand","type":"uint8"},{"name":"rndStr","type":"string"}],"name":"hostSubmitAndResult","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getHostSubmitHash","outputs":[{"name":"","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getGuestSubmitHash","outputs":[{"name":"","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"}]');
      const fs = require('fs');
      const contractJSON = JSON.parse(fs.readFileSync('../build/contracts/rps.json'));
      const abi = contractJSON.abi;
      const address = contractJSON.networks.'10'.address;
      //const address = '0x19157afc93ad7458eaad5d986d8ced652f9c4213';
      const contract = web3.eth.contract(abi).at(address);
      var error_check;
      var hostLocalHash = "";
      var hostEthHash = "";
      var guestLocalHash = "";
      var guestEthHash = "";
      function getAccounts(){
        var accounts = web3.eth.accounts;
        window.alert(accounts);
      }

      function unlock(){
        var passwd = document.fm_set_password.passwd.value;
        if(passwd == "" || passwd == null){
          window.alert("please enter password");
        }
        else{
          web3.personal.unlockAccount(coinbase,passwd)
             .then((response) => {
              console.log(response);
            }).catch((error) => {
              window.alert("Not correct password");
            });
        }
      }

      function getInput() {
        let get = {};
        let query = window.location.search.substring(1).split("&");
        for (let i in query) {
          if (query === "") continue;
          const param = query[i].split("=");
          get[decodeURIComponent(param[0])] = decodeURIComponent(param[1] || "");
        }
        return get.word;
      }

      function makeGame() {
        var rndStr = document.getElementById("hostRndStr").value;
        var hand;
        var radios = document.getElementsByName("hostHand");
        for(var i=0; i<radios.length;i++){
          if (radios[i].checked) {
            hand = radios[i].value;
            break;
          }
        }
        var concatStr = rndStr + hand;
        var jssha256 = new jsSHA('SHA-256', 'TEXT');
        jssha256.update(concatStr);
        hostLocalHash = jssha256.getHash('HEX');
        error_check = contract.makeGame.sendTransaction(hostLocalHash,{from:'0xac1288538d0b1727784dd4b1c90834894c8645aa',gas:1000000});
        console.log(error_check);
        document.getElementById("showHostLocalHash").innerHTML = hostLocalHash;
      }

      function joinGame() {
        var rndStr = document.getElementById("guestRndStr").value;
        var hand;
        var radios = document.getElementsByName("guestHand");
        for(var i=0; i<radios.length;i++){
          if (radios[i].checked) {
            hand = radios[i].value;
            break;
          }
        }
        var concatStr = rndStr + hand;
        var jssha256 = new jsSHA('SHA-256', 'TEXT');
        jssha256.update(concatStr);
        guestLocalHash = jssha256.getHash('HEX');
        error_check = contract.joinGame.sendTransaction(guestLocalHash,hand,rndStr,{from:'0x3ab9e3fc87169a4b09f5c60c64e2629c23a3901f',gas:1000000});
        console.log(error_check);
        document.getElementById("showGuestLocalHash").innerHTML = guestLocalHash;
      }
      
      function getHostEthHash() {
        var res = contract.getHostSubmitHash.call();
        console.log("response:"+res);
        document.getElementById("showHostEthHash").innerHTML = res;
        return res
      }

      function getGuestEthHash() {
        var res = contract.getGuestSubmitHash.call();
        console.log("response:"+res);
        document.getElementById("showGuestEthHash").innerHTML = res;
        return res;
      }

      function hostGameCheck() {
        hostEthHash = getHostEthHash();
        if (hostEthHash == hostLocalHash){
          console.log("host hash is matched!!");
          document.getElementById("hostCheckResult").innerHTML = "Hash Check Success!!!"
        }
        else{
          console.log("host hash is not corrected.");
          document.getElementById("hostCheckResult").innerHTML = "Hash not mach. Host lose..."
        }
      }

      function guestGameCheck() {
        guestEthHash = getGuestEthHash();
        if (guestEthHash == hostLocalHash){
          console.log("guest hash is matched!!");
          document.getElementById("guestCheckResult").innerHTML = "Hash Check Success!!!"
        }
        else{
          console.log("guest hash is not corrected.");
          document.getElementById("guestCheckResult").innerHTML = "Hash not mach. Guest lose..."
        }
      }

      var eventHostSubmit = contract.HostSubmit();
      var eventGuestSubmit = contract.GuestSubmit();
      eventHostSubmit.watch(function (error, result){
        console.log('watching host submit event');
        if (!error)
          console.log(result);
      });
      eventGuestSubmit.watch(function (error, result){
        console.log('watching guest submit event');
        if (!error)
          console.log(result);
      });
    </script>
  </head>

  <body>
    <h1>Ethereum RPS(rock,paper,scissors) Game </h1>
    <h2>Host Player</h2>
    <h4>Local Hash</h4>
    <div id = "showHostLocalHash"></div>
    <h4>Ethereum Hash</h4>
    <div id = "showHostEthHash"></div>
    <h3>New Game</h3>
    <p>
      Your Hand 
      <input type="radio" name="hostHand" value="1" checked="checked">Rock
      <input type="radio" name="hostHand" value="2">Scissor
      <input type="radio" name="hostHand" value="3">Paper
    </p>
    <p>
      Random String
      <input type="text" size=10 id="hostRndStr">
    </p>
    <p>
      <input type="button" value="START" onClick="makeGame()"/>
    </p>
    <h3>Game Check</h3>
    <p>
      <input type="button" value="Check" onClick="hostGameCheck()"/>
    </p>
    <div id = "hostCheckResult"></div>

    <h2>Guest Player</h2>
    <h4>Local Hash</h4>
    <div id = "showGuestLocalHash"></div>
    <h4>Ethereum Hash</h4>
    <div id = "showGuestEthHash"></div> 
    <h3>Join Game</h3>
    <p>
      Your Hand 
      <input type="radio" name="guestHand" value="1" checked="checked">Rock
      <input type="radio" name="guestHand" value="2">Scissor
      <input type="radio" name="guestHand" value="3">Paper
    </p>
    <p>
      Random String
      <input type="text" size=10 id="guestRndStr">
    </p>
    <p>
      <input type="button" value="START" onclick="joinGame()"/>
    </p>
    <h3>Game Check</h3>
    <p>
      <input type="button" value="Check" onClick="guestGameCheck()"/>
    </p>
    <div id = "guestCheckResult"></div>

  </body>
</html>
