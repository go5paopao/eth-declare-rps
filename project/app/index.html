<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>Ethereum RPS game</title>
    <script src="https://cdn.rawgit.com/ethereum/web3.js/0.19.0/dist/web3.min.js" charset="UTF-8"></script>
    <script src="../jsSHA/src/sha256.js" charset="UTF-8"></script>
    <script>
      web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
      var coinbase = web3.eth.coinbase;
      abi = JSON.parse('[{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"constant":false,"inputs":[{"name":"hashValue","type":"bytes32"}],"name":"makeGame","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"hashValue","type":"bytes32"},{"name":"hand","type":"uint8"},{"name":"rndStr","type":"string"}],"name":"joinGame","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"hand","type":"uint8"},{"name":"rndStr","type":"string"}],"name":"hostSubmitAndResult","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}]'); 
      address = '0xb1d79c7cbd0f2f5af9b15cdc93f381fb10c3ee1f';
      contract = web3.eth.contract(abi).at(address);
      var error_check;
      var hostLocalHash = "";
      var hostEthHash = "";
      var guestLocalHash = "";
      var guestEthHash = "";
      function getAccounts(){
        var accounts = web3.eth.accounts;
        window.alert(accounts);
      }

      function unlock(){
        var passwd = document.fm_set_password.passwd.value;
        if(passwd == "" || passwd == null){
          window.alert("please enter password");
        }
        else{
          web3.personal.unlockAccount(coinbase,passwd)
             .then((response) => {
              console.log(response);
            }).catch((error) => {
              window.alert("Not correct password");
            });
        }
      }

      function getInput() {
        let get = {};
        let query = window.location.search.substring(1).split("&");
        for (let i in query) {
          if (query === "") continue;
          const param = query[i].split("=");
          get[decodeURIComponent(param[0])] = decodeURIComponent(param[1] || "");
        }
        return get.word;
      }

      function sayHello(){
        const res = contract.sayHello.call();
        console.log("response:"+res);
        document.getElementById("message").innerText = "Message: " + res;
      }

      function setMessage() {
        var word = document.fm_set_message.word.value;
        var gas_amount = document.fm_set_message.gas.value;
        error_check = contract.setMessage.sendTransaction(word,{from:'0xcc42b148701fa703f9f8b006e3460cddba946baf',gas:gas_amount});
      }
      function makeGame() {
        var rndStr = document.getElementById("hostRndStr").value;
        var hand = document.getElementById("hostHand").value;
        var concatStr = rndStr + hand;
        var jssha256 = new jsSHA('SHA-256', 'TEXT');
        jssha256.update(concatStr);
        hostLocalHash = jssha256.getHash('HEX');
        error_check = contract.makeGame.sendTransaction(hostLocalHash,{from:'0xac1288538d0b1727784dd4b1c90834894c8645aa',gas:1000000});
        console.log(error_check);
        document.getElementById("divHostLocalHash").innerHTML = "local hash:"+hostLocalHash;
      }

      function joinGame() {
        var rndStr = document.getElementById("guestRndStr").value;
        var hand = document.getElementById("guestHand").value;
        var concatStr = rndStr + hand;
        var jssha256 = new jsSHA('SHA-256', 'TEXT');
        jssha256.update(concatStr);
        guestLocalHash = jssha256.getHash('HEX');
        error_check = contract.joinGame.sendTransaction(guestLocalHash,hand,rndStr,{from:'0x3ab9e3fc87169a4b09f5c60c64e2629c23a3901f',gas:1000000});
        console.log(error_check);
        document.getElementById("divGuestLocalHash").innerHTML = "local hash:"+guestLocalHash;
      }

      function reload() {
        document.getElementById("divHostLocalHash").innerHTML = "local hash:"+hostLocalHash;
        document.getElementById("divHostEthHash").innerHTML = "ethereum hash:"+hostEthHash;
        document.getElementById("divGuestLocalHash").innerHTML = "local hash:"+guestLocalHash;
        document.getElementById("divGuestEthHash").innerHTML = "ethereum hash:"+guestEthHash;

      }
    </script>
  </head>

  <body>
    <h1>Ethereum RPS(rock,paper,scissors) Game </h1>
    <h3>Host Player</h3>
    <div id = "divHostLocalHash">local hash:</div>
    <div id = "divHostEthHash">ethereum hash:</div>
    <h5>New Game</h5>
    <p>
      Your Hand 
      <input type="radio" id="hostHand" value="1" checked="checked">Rock
      <input type="radio" id="hostHand" value="2">Scissor
      <input type="radio" id="hostHand" value="3">Paper
    </p>
    <p>
      Random String
      <input type="text" size=10 id="hostRndStr">
    </p>
    <p>
      <input type="button" value="START" onClick="makeGame()"/>
    </p>
    <h5>Game Check</h5>
    <h3>Guest Player</h3>
    <div id = "divGuestLocalHash">local hash:</div>
    <div id = "divGuestEthHash">ethereum hash:</div> 
    <H5>Join Game</h5>
    <p>
      Your Hand 
      <input type="radio" id="guestHand" value="1" checked="checked">Rock
      <input type="radio" id="guestHand" value="2">Scissor
      <input type="radio" id="guestHand" value="3">Paper
    </p>
    <p>
      Random String
      <input type="text" size=10 id="guestRndStr">
    </p>
    <p>
      <input type="button" value="START" onclick="joinGame()"/>
    </p>
    <h3>Other</h3>
    <input type="button" value="Reload" onclick="reload()">

    <div id="message"></div>
  </body>
</html>
